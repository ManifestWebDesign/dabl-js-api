"use strict";angular.module("dablAuth",["dabl"]),angular.module("dablAuth").service("Auth",["$rootScope","$localstorage",function(a,b){var c={},d=null;c.setLoggedInUser=function(a){d=a},c.setUser=function(e){var f=d;c.setLoggedInUser(e),null===f&&e&&e.id?a.$broadcast("dabl-auth.user.logged-in"):null===e&&a.$broadcast("dabl-auth.user.logged-out"),b.set("user",e)},c.getUser=function(){return d},c.getToken=function(){return d&&"undefined"!=typeof d.authentication_token?d.authToken:null},c.getEmail=function(){return d&&"undefined"!=typeof d.email?d.email:null},c.isLoggedIn=function(){return d&&"undefined"!=typeof d.email&&"undefined"!=typeof d.authToken},c.checkAuthorization=function(a){return!!("undefined"!=typeof a&&"undefined"!=typeof a.data&&"undefined"!=typeof a.data.bypassAuth&&a.data.bypassAuth||c.isLoggedIn())},c.globalAdminIsLoggedIn=function(){var a=c.getUser();return a&&1===a.type},c.projectManagerIsLoggedIn=function(){var a=c.getUser();return a&&2===a.type},c.reset=function(){c.setUser(null)},c.passwordIsValid=function(a){return a.length>=8&&a.match(/[A-Z]+/)&&a.match(/[a-z]+/)&&a.match(/[0-9]+/)};var e=b.get("user");return e&&c.setUser(e),c}]),angular.module("dablAuth").factory("httpInterceptor",["API_HASH","API_SECRET","security","Auth","$q","$rootScope","dablAuthConfig",function(a,b,c,d,e,f,g){function h(b){return g.header+a+":"+b}function i(a){var e=Date.now()/1e3|0,f=c.getHMAC(b,[a,e].join(",")),g={"X-Timestamp":e,Authorization:h(f)};return d.isLoggedIn()&&(g["X-Email"]=d.getUser().email,g["X-User-Token"]=d.getUser().authToken),g}return{request:function(a){var b=i(a.url);if("undefined"!=typeof a.headers["X-Timestamp"])return a;for(var c in b)a.headers[c]=b[c];return a},responseError:function(a){return f.$broadcast("dabl-auth.response.error",a),e.reject(a)},generateHeaders:i}}]),angular.module("dablAuth").factory("$localstorage",["$window",function(a){return{get:function(b,c){var d=a.localStorage[b];return d?JSON.parse(d):c},set:function(b,c){a.localStorage[b]=JSON.stringify(c)},remove:function(b){return delete a.localStorage[b]}}}]),angular.module("dablAuth").factory("security",["jsSHA",function(a){var b={};if("undefined"==typeof a)throw new Error("jsSHA is not included");return b.getHMAC=function(b,c){var d=new a("SHA-512","TEXT");return d.setHMACKey(b,"TEXT"),d.update(c),d.getHMAC("HEX")},b.getHash=function(b,c){c=c||"SHA-512";var d=new a(c,"TEXT");return d.update(b),d.getHash("HEX")},b.encode64=function(a){return btoa(a)},b.decode64=function(a){return atob(a)},b}]),angular.module("dablAuth").factory("serverApi",["$q","$http","API_URL",function(a,b,c){var d={makeRequest:function(d,e,f,g){e=e||"",f=f?f.toUpperCase():""===e?"GET":"POST","/"===d.charAt(0)&&(d=d.substring(1));var h=a.defer(),i={method:f,url:c+"/"+d,data:e,timeout:h.promise};"undefined"!=typeof g&&(i.headers={"Content-Type":g});var j=b(i).then(function(a){return a.data},function(b){return a.reject(b)});return j.abort=function(){h.resolve()},j["finally"](function(){j.abort=angular.noop,h=j=null}),j},serialize:function(a,b){var c=[];for(var e in a)if(a.hasOwnProperty(e)){var f=b?b+"["+e+"]":e,g=a[e];c.push("object"==typeof g?d.serialize(g,f):encodeURIComponent(f)+"="+encodeURIComponent(g))}return c.join("&")},unserialize:function(a){var b={},c=a.split("&");return angular.forEach(c,function(a){if(!(a.length<1)){var c=a.split("=");if(-1!==c[0].indexOf("[")){var d,e,f=c[0].indexOf("["),g=c[0].indexOf("]");++f,g-=f,e=c[0].substr(0,f-1),d=c[0].substr(f,g),"undefined"==typeof b[e]&&(b[e]={}),b[e][d]=c[1]}else b[decodeURIComponent(c[0])]=decodeURIComponent(c[1])}}),b}};return d}]),angular.module("dablAuth").factory("siteUrl",["API_URL",function(a){var b=16;return function(c,d){return c=c||"",-1===c.indexOf("http://")&&-1===c.indexOf("https://")&&(c=a+"/"+(c?c:"")),d&&(c+="?v="+b),c}}]),angular.module("dablAuth").service("userApi",["security","serverApi",function(a,b){var c={},d="users";return c.signIn=function(c,e){var f=d+"/login",g="application/x-www-form-urlencoded",h="credentials="+a.encode64([c,e].join(":"));return b.makeRequest(f,h,"post",g)},c.signOut=function(){var a=d+"/login/logout";return b.makeRequest(a,null,"get")},c}]);